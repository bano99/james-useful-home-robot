name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ROS2 Build and Test
  ros2-build:
    runs-on: ubuntu-24.04
    container:
      image: ros:jazzy
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        apt-get update
        apt-get install -y python3-pip python3-colcon-common-extensions python3-pytest
        # Use apt instead of pip to avoid externally-managed-environment error
    
    - name: Build ROS2 workspace
      run: |
        cd ros2_ws
        source /opt/ros/jazzy/setup.bash
        # Skip build if no packages exist yet
        if [ -d "src" ] && [ "$(ls -A src)" ]; then
          colcon build --symlink-install
        else
          echo "No ROS2 packages found yet, skipping build"
        fi
    
    - name: Run ROS2 tests
      run: |
        cd ros2_ws
        source /opt/ros/jazzy/setup.bash
        # Skip tests if no packages exist yet
        if [ -d "src" ] && [ "$(ls -A src)" ]; then
          source install/setup.bash
          colcon test
          colcon test-result --verbose
        else
          echo "No ROS2 packages found yet, skipping tests"
        fi

  # Python Linting and Testing
  python-quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black pytest pylint mypy
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Lint with flake8
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Check formatting with black
      run: |
        black --check --diff ros2_ws/src scripts tests
    
    - name: Run Python tests
      run: |
        pytest tests/ -v

  # ESP32 Firmware Build
  esp32-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio
    
    - name: Build Platform Controller
      run: |
        cd platform/controller
        if [ -f platformio.ini ]; then
          pio run
        else
          echo "PlatformIO project not yet configured"
        fi
    
    - name: Build Remote Control
      run: |
        cd platform/remote
        if [ -f platformio.ini ]; then
          pio run
        else
          echo "PlatformIO project not yet configured"
        fi

  # Documentation Build
  docs-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check markdown links
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        config-file: '.github/markdown-link-check-config.json'
    
    - name: Validate README
      run: |
        if [ ! -f README.md ]; then
          echo "README.md not found!"
          exit 1
        fi
        echo "README.md exists and is valid"

  # Integration Tests (runs only on main branch)
  integration-tests:
    runs-on: ubuntu-24.04
    if: github.ref == 'refs/heads/main'
    needs: [ros2-build, python-quality]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install test dependencies
      run: |
        pip install pytest pytest-cov
    
    - name: Run integration tests
      run: |
        if [ -d tests ]; then
          pytest tests/integration/ -v --cov=ros2_ws/src
        else
          echo "Integration tests not yet implemented"
        fi
